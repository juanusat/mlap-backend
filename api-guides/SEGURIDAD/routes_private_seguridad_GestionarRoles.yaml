openapi: 3.0.0
info:
  title: Gestión de Roles de Parroquia
  description: APIs para la administración de roles dentro de una Parroquia específica, incluyendo CRUD de roles y gestión de permisos asociados a cada rol.
  version: 1.0.0
servers:
  - url: /
    description: URL base para las APIs

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      
  schemas:
    RoleSummary:
      type: object
      description: Resumen de la información de un rol para listados.
      properties:
        role_id:
          type: integer
          description: ID del rol.
          example: 1
        name:
          type: string
          description: Nombre del rol.
          example: Rol de Ejemplo 1
        description:
          type: string
          nullable: true
          description: Descripción del rol.
          example: Descripción del rol de ejemplo número 1.
        active:
          type: boolean
          description: Estado del rol (Activo/Inactivo).
          example: true

    RoleListResponse:
      type: object
      properties:
        total_records:
          type: integer
          description: Número total de roles que cumplen el filtro.
          example: 50
        total_pages:
          type: integer
          description: Número total de páginas.
          example: 5
        current_page:
          type: integer
          description: Número de página actual.
          example: 1
        roles:
          type: array
          items:
            $ref: '#/components/schemas/RoleSummary'

    RoleCreateRequest:
      type: object
      required:
        - name
        - description
      properties:
        name:
          type: string
          description: Nombre del nuevo rol (debe ser único por parroquia).
          example: Vicario
        description:
          type: string
          nullable: true
          description: Descripción detallada del rol.
          example: Encargado de las funciones administrativas y litúrgicas del párroco.

    RoleCreationResponse:
      type: object
      properties:
        message:
          type: string
          example: Rol creado exitosamente.
        role_id:
          type: integer
          description: ID del rol recién creado.
          example: 15
        name:
          type: string
          example: Vicario

    RoleDetail:
      type: object
      description: Información completa de un rol específico.
      properties:
        role_id:
          type: integer
          example: 1
        parish_id:
          type: integer
          description: ID de la Parroquia a la que pertenece el rol.
          example: 15
        name:
          type: string
          example: Rol de Ejemplo 1
        description:
          type: string
          nullable: true
          example: Descripción del rol de ejemplo número 1.
        active:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
          description: Fecha y hora de creación del rol.
          example: 2024-05-01T10:00:00Z

    RoleUpdateRequest:
      type: object
      required:
        - name
        - description
      properties:
        name:
          type: string
          description: Nuevo nombre del rol.
          example: Nuevo Nombre del Rol
        description:
          type: string
          nullable: true
          description: Nueva descripción del rol.
          example: Nueva descripción actualizada.

    RoleUpdateResponse:
      type: object
      properties:
        message:
          type: string
          example: Rol actualizado exitosamente.
        role_id:
          type: integer
          example: 1

    RoleStatusRequest:
      type: object
      required:
        - active
      properties:
        active:
          type: boolean
          description: true para activar, false para desactivar.
          example: false

    RoleStatusResponse:
      type: object
      properties:
        message:
          type: string
          example: Estado del rol actualizado exitosamente (Desactivado).
        role_id:
          type: integer
          example: 1
        active:
          type: boolean
          example: false

    RoleDeleteResponse:
      type: object
      properties:
        message:
          type: string
          example: Rol desactivado/eliminado lógicamente exitosamente.
        role_id:
          type: integer
          example: 1

    PermissionUpdateItem:
      type: object
      required:
        - permission_id
        - granted
      properties:
        permission_id:
          type: integer
          description: ID del permiso del catálogo global.
          example: 1
        granted:
          type: boolean
          description: Asignar (true) o Revocar (false) el permiso.
          example: true
          
    RolePermissionsUpdateRequest:
      type: object
      required:
        - permissions
      properties:
        permissions:
          type: array
          description: Lista de permisos a modificar (asignar o revocar).
          items:
            $ref: '#/components/schemas/PermissionUpdateItem'

    RolePermissionsUpdateResponse:
      type: object
      properties:
        message:
          type: string
          example: Permisos del rol actualizados exitosamente.
        role_id:
          type: integer
          example: 1
        updated_count:
          type: integer
          description: Número de permisos que fueron asignados o revocados en esta operación.
          example: 3
          
    StandardResponse:
      type: object
      properties:
        message:
          type: string
          description: Lo que el backend indica al frontend que debe mostrar
          example: "Roles obtenidos exitosamente"
        data:
          description: La información, puede ser un arreglo
          oneOf:
            - type: object
            - type: array
            - type: integer
            - type: string
          example: {}
        error:
          type: string
          description: Es vacío si no hay ningún error
          example: ""
        traceback:
          type: string
          description: Todo el error generado en el backend si la respuesta es código 500
          example: ""

    RoleListRequest:
      type: object
      required:
        - page
        - limit
      properties:
        page:
          type: integer
          description: Número de página
          example: 1
        limit:
          type: integer
          description: Límite de registros por página
          example: 10

    RoleSearchRequest:
      type: object
      required:
        - page
        - limit
        - search
      properties:
        page:
          type: integer
          description: Número de página
          example: 1
        limit:
          type: integer
          description: Límite de registros por página
          example: 10
        search:
          type: string
          description: Término de búsqueda para filtrar roles
          example: "Administrador"

security:
  - bearerAuth: []

paths:
  /api/parish/{parishId}/roles/list:
    post:
      tags:
        - Gestión de Roles
      summary: Listar Roles de la Parroquia
      description: Obtiene la lista paginada de roles definidos por la Parroquia {parishId}.
      parameters:
        - in: path
          name: parishId
          schema:
            type: integer
          description: ID de la Parroquia que está administrando.
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleListRequest'
      responses:
        '200':
          description: Listado paginado de roles.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Roles obtenidos exitosamente"
                data:
                  total_records: 50
                  total_pages: 5
                  current_page: 1
                  roles:
                    - role_id: 1
                      name: Rol de Ejemplo 1
                      description: Descripción del rol de ejemplo número 1.
                      active: true
                error: ""
                traceback: ""
    
  /api/parish/{parishId}/roles/search:
    post:
      tags:
        - Gestión de Roles
      summary: Buscar Roles de la Parroquia
      description: Busca roles por nombre en la Parroquia {parishId}.
      parameters:
        - in: path
          name: parishId
          schema:
            type: integer
          description: ID de la Parroquia que está administrando.
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleSearchRequest'
      responses:
        '200':
          description: Resultados de búsqueda de roles.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Búsqueda de roles completada exitosamente"
                data:
                  total_records: 5
                  total_pages: 1
                  current_page: 1
                  roles:
                    - role_id: 1
                      name: Administrador
                      description: Rol de administrador del sistema
                      active: true
                error: ""
                traceback: ""
     
  /api/parish/{parishId}/roles/create:
    post:
      tags:
        - Gestión de Roles
      summary: Crear Rol
      description: Crea un nuevo rol dentro del contexto de la parroquia {parishId}.
      parameters:
        - in: path
          name: parishId
          schema:
            type: integer
          description: ID de la Parroquia.
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleCreateRequest'
      responses:
        '201':
          description: Rol creado exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'


  /api/parish/{parishId}/roles/{roleId}:
    get:
      tags:
        - Gestión de Roles
      summary: Ver/Obtener Detalles del Rol
      description: Obtiene la información completa de un rol específico.
      parameters:
        - in: path
          name: roleId
          schema:
            type: integer
          description: ID del rol.
          required: true
      responses:
        '200':
          description: Detalles del rol obtenidos exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Detalles del rol obtenidos exitosamente"
                data:
                  name: "Administrador"
                  description: "Rol con permisos completos para la gestión de la parroquia y todos los módulos del sistema"
                error: ""
                traceback: ""
     
    put:
      tags:
        - Gestión de Roles
      summary: Editar Rol (Nombre y Descripción)
      description: Modifica el nombre y la descripción de un rol existente.
      parameters:
        - in: path
          name: roleId
          schema:
            type: integer
          description: ID del rol a editar.
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleUpdateRequest'
      responses:
        '200':
          description: Rol actualizado exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'

    delete:
      tags:
        - Gestión de Roles
      summary: Eliminar Rol (Desactivación/Borrado Lógico)
      description: Desactiva o elimina lógicamente el rol.
      parameters:
        - in: path
          name: roleId
          schema:
            type: integer
          description: ID del rol a eliminar.
          required: true
      responses:
        '200':
          description: Rol desactivado/eliminado lógicamente exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
     
  /api/parish/{parishId}/roles/{roleId}/status:
    patch:
      tags:
        - Gestión de Roles
      summary: Desactivar/Activar Rol (Toggle Estado)
      description: Cambia el estado 'active' del rol.
      parameters:
        - in: path
          name: roleId
          schema:
            type: integer
          description: ID del rol a modificar.
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleStatusRequest'
      responses:
        '200':
          description: Estado del rol actualizado exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
     
  /api/parish/{parishId}/roles/{roleId}/permissions:
    get:
      tags:
        - Gestión de Roles (Permisos)
      summary: Obtener Listado de Permisos del Rol
      description: Obtiene el listado de permisos actual del rol, organizada por módulos y acciones.
      parameters:
        - in: path
          name: roleId
          schema:
            type: integer
          description: ID del rol para consultar permisos.
          required: true
      responses:
        '200':
          description: Matriz de permisos obtenida exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Permisos del rol obtenidos exitosamente"
                data:
                  role_name: "Rol de Ejemplo 1"
                  modules:
                    - module_name: "Actos Litúrgicos"
                      sections:
                        - section_name: "Gestionar actos litúrgicos"
                          permissions:
                            - id: 1
                              code: "C_ACTOS_LITURGICOS_ACTOS"
                              name: "Crear acto litúrgico"
                              description: "Permite crear nuevos actos litúrgicos."
                              assigned: true
                            - id: 2
                              code: "U_ESTADO_ACTOS_LITURGICOS"
                              name: "Actualizar estado acto litúrgico"
                              description: "Permite cambiar el estado de los actos litúrgicos."
                              assigned: true
                            - id: 3
                              code: "R_ACTOS_LITURGICOS_ACTOS"
                              name: "Leer acto litúrgico"
                              description: "Permite visualizar los detalles de los actos litúrgicos."
                              assigned: true
                            - id: 4
                              code: "U_ACTOS_LITURGICOS_ACTOS"
                              name: "Actualizar acto litúrgico"
                              description: "Permite modificar la información de los actos litúrgicos."
                              assigned: false
                            - id: 5
                              code: "D_ACTOS_LITURGICOS_ACTOS"
                              name: "Eliminar acto litúrgico"
                              description: "Permite eliminar actos litúrgicos."
                              assigned: false
                        - section_name: "Gestionar requisitos"
                          permissions:
                            - id: 6
                              code: "C_ACTOS_LITURGICOS_REQ"
                              name: "Crear requisitos"
                              description: "Permite definir nuevos requisitos para actos litúrgicos."
                              assigned: true
                            - id: 7
                              code: "U_ESTADO_REQ_ACTOS_LIT"
                              name: "Actualizar estado requisitos"
                              description: "Permite cambiar el estado de los requisitos."
                              assigned: true
                            - id: 8
                              code: "R_ACTOS_LITURGICOS_REQ"
                              name: "Leer requisitos"
                              description: "Permite visualizar los requisitos definidos."
                              assigned: true
                            - id: 9
                              code: "U_ACTOS_LITURGICOS_REQ"
                              name: "Actualizar requisitos"
                              description: "Permite modificar los requisitos existentes."
                              assigned: false
                            - id: 10
                              code: "D_ACTOS_LITURGICOS_REQ"
                              name: "Eliminar requisitos"
                              description: "Permite eliminar requisitos."
                              assigned: false
                        - section_name: "Gestionar horarios"
                          permissions:
                            - id: 11
                              code: "C_ACTOS_LITURGICOS_HORA"
                              name: "Crear horario"
                              description: "Permite definir nuevos horarios de actos litúrgicos."
                              assigned: true
                            - id: 12
                              code: "U_ACTOS_LITURGICOS_HORA"
                              name: "Actualizar horario"
                              description: "Permite modificar horarios existentes."
                              assigned: false
                            - id: 13
                              code: "C_EXCEP_DISP"
                              name: "Crear Excepción - Disponibilidad"
                              description: "Permite crear excepciones de disponibilidad en el horario."
                              assigned: false
                            - id: 14
                              code: "U_EXCEP_DISP"
                              name: "Actualizar Excepción - Disponibilidad"
                              description: "Permite modificar excepciones de disponibilidad existentes."
                              assigned: false
                            - id: 15
                              code: "D_EXCEP_DISP"
                              name: "Eliminar Excepción - Disponibilidad"
                              description: "Permite eliminar excepciones de disponibilidad."
                              assigned: false
                            - id: 16
                              code: "C_EXCEP_NO_DISP"
                              name: "Crear Excepción NO - Disponibilidad"
                              description: "Permite crear excepciones de NO disponibilidad en el horario."
                              assigned: false
                            - id: 17
                              code: "U_EXCEP_NO_DISP"
                              name: "Actualizar Excepción NO - Disponibilidad"
                              description: "Permite modificar excepciones de NO disponibilidad existentes."
                              assigned: false
                            - id: 18
                              code: "D_EXCEP_NO_DISP"
                              name: "Eliminar Excepción NO - Disponibilidad"
                              description: "Permite eliminar excepciones de NO disponibilidad."
                              assigned: false
                        - section_name: "Gestionar Reservas"
                          permissions:
                            - id: 19
                              code: "R_ACTOS_LITURGICOS_RESER"
                              name: "Leer reservas"
                              description: "Permite visualizar las reservas gestionadas."
                              assigned: true
                            - id: 20
                              code: "U_ACTOS_LITURGICOS_RESER"
                              name: "Actualizar reservas"
                              description: "Permite modificar o cambiar el estado de las reservas gestionadas."
                              assigned: true
                    - module_name: "Reservas"
                      sections:
                        - section_name: "Reservas pendientes"
                          permissions:
                            - id: 21
                              code: "D_RESERVAS_PEND"
                              name: "Eliminar reserva (Pendientes)"
                              description: "Permite eliminar o rechazar reservas que están pendientes de aprobación."
                              assigned: false
                        - section_name: "Historial de reservas"
                          permissions:
                            - id: 22
                              code: "R_RESERVAS_HIST"
                              name: "Leer reserva (Historial)"
                              description: "Permite visualizar el historial completo de una reserva."
                              assigned: true
                        - section_name: "Reservar evento"
                          permissions:
                            - id: 23
                              code: "C_RESERVAS_EVENTO"
                              name: "Crear reserva"
                              description: "Permite generar una nueva solicitud de reserva de evento."
                              assigned: true
                    - module_name: "Seguridad"
                      sections:
                        - section_name: "Gestionar cuentas"
                          permissions:
                            - id: 24
                              code: "C_SEGURIDAD_ASOC_USER"
                              name: "Crear asociación usuario"
                              description: "Permite asociar un nuevo usuario al sistema."
                              assigned: true
                            - id: 25
                              code: "U_ESTADO_ASOC_USER"
                              name: "Actualizar estado asociación usuario"
                              description: "Permite cambiar el estado de la asociación de un usuario."
                              assigned: true
                            - id: 26
                              code: "R_SEGURIDAD_ASOC_USER"
                              name: "Leer asociación usuario"
                              description: "Permite visualizar la lista y detalles de las asociaciones de usuarios."
                              assigned: true
                            - id: 27
                              code: "C_ROL_ASOC_USER"
                              name: "Crear rol - asociación usuario"
                              description: "Permite asignar un rol a un usuario al momento de la asociación."
                              assigned: false
                            - id: 28
                              code: "D_SEGURIDAD_ASOC_USER"
                              name: "Eliminar asociación usuario"
                              description: "Permite desvincular o eliminar la asociación de un usuario."
                              assigned: false
                        - section_name: "Gestionar roles"
                          permissions:
                            - id: 29
                              code: "C_SEGURIDAD_ROL"
                              name: "Crear rol"
                              description: "Permite crear nuevos roles de usuario."
                              assigned: true
                            - id: 30
                              code: "U_ESTADO_ROL"
                              name: "Actualizar estado rol"
                              description: "Permite cambiar el estado de un rol (habilitar/deshabilitar)."
                              assigned: true
                            - id: 31
                              code: "R_SEGURIDAD_ROL"
                              name: "Leer rol"
                              description: "Permite visualizar la lista de roles existentes."
                              assigned: true
                            - id: 32
                              code: "U_SEGURIDAD_ROL_PERMS"
                              name: "Actualizar rol - permisos"
                              description: "Permite modificar los permisos asignados a un rol."
                              assigned: true
                            - id: 33
                              code: "U_SEGURIDAD_ROL_DATA"
                              name: "Actualizar rol"
                              description: "Permite modificar la información básica de un rol (nombre, descripción)."
                              assigned: false
                            - id: 34
                              code: "D_SEGURIDAD_ROL"
                              name: "Eliminar rol"
                              description: "Permite eliminar roles."
                              assigned: false
                    - module_name: "Parroquia"
                      sections:
                        - section_name: "Gestionar cuenta"
                          permissions:
                            - id: 35
                              code: "R_PARROQUIA_INFO"
                              name: "Leer información de la parroquia"
                              description: "Permite visualizar los datos generales de la parroquia."
                              assigned: true
                            - id: 36
                              code: "U_PARROQUIA_INFO"
                              name: "Actualizar información de la parroquia"
                              description: "Permite modificar los datos generales de la parroquia."
                              assigned: false
                            - id: 37
                              code: "R_PARROQUIA_DATOS_CUENTA"
                              name: "Leer Datos de la cuenta"
                              description: "Permite visualizar la información de la cuenta bancaria/financiera de la parroquia."
                              assigned: false
                            - id: 38
                              code: "U_PARROQUIA_DATOS_CUENTA"
                              name: "Actualizar Datos de la cuenta"
                              description: "Permite modificar la información de la cuenta bancaria/financiera de la parroquia."
                              assigned: false
                        - section_name: "Gestionar capilla"
                          permissions:
                            - id: 39
                              code: "C_PARROQUIA_CAPILLA"
                              name: "Crear capilla"
                              description: "Permite registrar una nueva capilla."
                              assigned: true
                            - id: 40
                              code: "U_ESTADO_CAPILLA"
                              name: "Actualizar estado capilla"
                              description: "Permite cambiar el estado de una capilla (habilitar/deshabilitar)."
                              assigned: false
                            - id: 41
                              code: "R_PARROQUIA_CAPILLA"
                              name: "Leer capilla"
                              description: "Permite visualizar el listado y detalles de las capillas."
                              assigned: true
                            - id: 42
                              code: "U_PARROQUIA_CAPILLA"
                              name: "Actualizar capilla"
                              description: "Permite modificar la información de una capilla."
                              assigned: false
                            - id: 43
                              code: "D_PARROQUIA_CAPILLA"
                              name: "Eliminar capilla"
                              description: "Permite eliminar o inhabilitar una capilla."
                              assigned: false
                error: ""
                traceback: ""

    put:
      tags:
        - Gestión de Roles (Permisos)
      summary: Guardar Cambios en listado de Permisos
      description: Guarda los cambios realizados en el listado de permisos del rol (botón "Guardar" del modal).
      parameters:
        - in: path
          name: roleId
          schema:
            type: integer
          description: ID del rol al que se modificarán los permisos.
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RolePermissionsUpdateRequest'
      responses:
        '200':
          description: Permisos del rol actualizados exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Permisos del rol actualizados exitosamente"
                data: {}
                error: ""
                traceback: ""