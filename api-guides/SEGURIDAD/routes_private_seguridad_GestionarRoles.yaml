openapi: 3.0.0
info:
  title: Gestión de Roles de Parroquia
  description: APIs para la administración de roles dentro de una Parroquia específica, incluyendo CRUD de roles y gestión de permisos asociados a cada rol.
  version: 1.0.0
servers:
  - url: /
    description: URL base para las APIs

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      
  schemas:
    RoleSummary:
      type: object
      description: Resumen de la información de un rol para listados.
      properties:
        role_id:
          type: integer
          description: ID del rol.
          example: 1
        name:
          type: string
          description: Nombre del rol.
          example: Rol de Ejemplo 1
        description:
          type: string
          nullable: true
          description: Descripción del rol.
          example: Descripción del rol de ejemplo número 1.
        active:
          type: boolean
          description: Estado del rol (Activo/Inactivo).
          example: true

    RoleListResponse:
      type: object
      properties:
        total_records:
          type: integer
          description: Número total de roles que cumplen el filtro.
          example: 50
        total_pages:
          type: integer
          description: Número total de páginas.
          example: 5
        current_page:
          type: integer
          description: Número de página actual.
          example: 1
        roles:
          type: array
          items:
            $ref: '#/components/schemas/RoleSummary'

    RoleCreateRequest:
      type: object
      required:
        - name
        - description
      properties:
        name:
          type: string
          description: Nombre del nuevo rol (debe ser único por parroquia).
          example: Vicario
        description:
          type: string
          nullable: true
          description: Descripción detallada del rol.
          example: Encargado de las funciones administrativas y litúrgicas del párroco.

    RoleCreationResponse:
      type: object
      properties:
        message:
          type: string
          example: Rol creado exitosamente.
        role_id:
          type: integer
          description: ID del rol recién creado.
          example: 15
        name:
          type: string
          example: Vicario

    RoleDetail:
      type: object
      description: Información completa de un rol específico.
      properties:
        role_id:
          type: integer
          example: 1
        parish_id:
          type: integer
          description: ID de la Parroquia a la que pertenece el rol.
          example: 15
        name:
          type: string
          example: Rol de Ejemplo 1
        description:
          type: string
          nullable: true
          example: Descripción del rol de ejemplo número 1.
        active:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
          description: Fecha y hora de creación del rol.
          example: 2024-05-01T10:00:00Z

    RoleUpdateRequest:
      type: object
      required:
        - name
        - description
      properties:
        name:
          type: string
          description: Nuevo nombre del rol.
          example: Nuevo Nombre del Rol
        description:
          type: string
          nullable: true
          description: Nueva descripción del rol.
          example: Nueva descripción actualizada.

    RoleUpdateResponse:
      type: object
      properties:
        message:
          type: string
          example: Rol actualizado exitosamente.
        role_id:
          type: integer
          example: 1

    RoleStatusRequest:
      type: object
      required:
        - active
      properties:
        active:
          type: boolean
          description: true para activar, false para desactivar.
          example: false

    RoleStatusResponse:
      type: object
      properties:
        message:
          type: string
          example: Estado del rol actualizado exitosamente (Desactivado).
        role_id:
          type: integer
          example: 1
        active:
          type: boolean
          example: false

    RoleDeleteResponse:
      type: object
      properties:
        message:
          type: string
          example: Rol desactivado/eliminado lógicamente exitosamente.
        role_id:
          type: integer
          example: 1

    PermissionUpdateItem:
      type: object
      required:
        - permission_id
        - granted
      properties:
        permission_id:
          type: integer
          description: ID del permiso del catálogo global.
          example: 1
        granted:
          type: boolean
          description: Asignar (true) o Revocar (false) el permiso.
          example: true
          
    RolePermissionsUpdateRequest:
      type: object
      required:
        - permissions
      properties:
        permissions:
          type: array
          description: Lista de permisos a modificar (asignar o revocar).
          items:
            $ref: '#/components/schemas/PermissionUpdateItem'

    RolePermissionsUpdateResponse:
      type: object
      properties:
        message:
          type: string
          example: Permisos del rol actualizados exitosamente.
        role_id:
          type: integer
          example: 1
        updated_count:
          type: integer
          description: Número de permisos que fueron asignados o revocados en esta operación.
          example: 3
          
    StandardResponse:
      type: object
      properties:
        message:
          type: string
          description: Lo que el backend indica al frontend que debe mostrar
          example: "Roles obtenidos exitosamente"
        data:
          description: La información, puede ser un arreglo
          oneOf:
            - type: object
            - type: array
            - type: integer
            - type: string
          example: {}
        error:
          type: string
          description: Es vacío si no hay ningún error
          example: ""
        traceback:
          type: string
          description: Todo el error generado en el backend si la respuesta es código 500
          example: ""

    RoleListRequest:
      type: object
      required:
        - page
        - limit
      properties:
        page:
          type: integer
          description: Número de página
          example: 1
        limit:
          type: integer
          description: Límite de registros por página
          example: 10

    RoleSearchRequest:
      type: object
      required:
        - page
        - limit
        - search
      properties:
        page:
          type: integer
          description: Número de página
          example: 1
        limit:
          type: integer
          description: Límite de registros por página
          example: 10
        search:
          type: string
          description: Término de búsqueda para filtrar roles
          example: "Administrador"

security:
  - bearerAuth: []

paths:
  /api/parish/{parishId}/roles/list:
    post:
      tags:
        - Gestión de Roles
      summary: Listar Roles de la Parroquia
      description: Obtiene la lista paginada de roles definidos por la Parroquia {parishId}.
      parameters:
        - in: path
          name: parishId
          schema:
            type: integer
          description: ID de la Parroquia que está administrando.
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleListRequest'
      responses:
        '200':
          description: Listado paginado de roles.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Roles obtenidos exitosamente"
                data:
                  - role_id: 1
                    name: Rol de Ejemplo 1
                    description: Descripción del rol de ejemplo número 1.
                    active: true
                error: ""
                traceback: ""
                meta:
                  total_records: 100
    
  /api/parish/{parishId}/roles/search:
    post:
      tags:
        - Gestión de Roles
      summary: Buscar Roles de la Parroquia
      description: Busca roles por nombre en la Parroquia {parishId}.
      parameters:
        - in: path
          name: parishId
          schema:
            type: integer
          description: ID de la Parroquia que está administrando.
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleSearchRequest'
      responses:
        '200':
          description: Resultados de búsqueda de roles.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Búsqueda de roles completada exitosamente"
                data:
                  - role_id: 1
                    name: Administrador
                    description: Rol de administrador del sistema
                    active: true
                error: ""
                traceback: ""
                meta:
                  total_records: 100
     
  /api/parish/{parishId}/roles/create:
    post:
      tags:
        - Gestión de Roles
      summary: Crear Rol
      description: Crea un nuevo rol dentro del contexto de la parroquia {parishId}.
      parameters:
        - in: path
          name: parishId
          schema:
            type: integer
          description: ID de la Parroquia.
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleCreateRequest'
      responses:
        '201':
          description: Rol creado exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'


  /api/parish/{parishId}/roles/{roleId}:
    get:
      tags:
        - Gestión de Roles
      summary: Ver/Obtener Detalles del Rol
      description: Obtiene la información completa de un rol específico.
      parameters:
        - in: path
          name: roleId
          schema:
            type: integer
          description: ID del rol.
          required: true
      responses:
        '200':
          description: Detalles del rol obtenidos exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Detalles del rol obtenidos exitosamente"
                data:
                  name: "Administrador"
                  description: "Rol con permisos completos para la gestión de la parroquia y todos los módulos del sistema"
                error: ""
                traceback: ""
     
    put:
      tags:
        - Gestión de Roles
      summary: Editar Rol (Nombre y Descripción)
      description: Modifica el nombre y la descripción de un rol existente.
      parameters:
        - in: path
          name: roleId
          schema:
            type: integer
          description: ID del rol a editar.
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleUpdateRequest'
      responses:
        '200':
          description: Rol actualizado exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'

    delete:
      tags:
        - Gestión de Roles
      summary: Eliminar Rol (Desactivación/Borrado Lógico)
      description: Desactiva o elimina lógicamente el rol.
      parameters:
        - in: path
          name: roleId
          schema:
            type: integer
          description: ID del rol a eliminar.
          required: true
      responses:
        '200':
          description: Rol desactivado/eliminado lógicamente exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
     
  /api/parish/{parishId}/roles/{roleId}/status:
    patch:
      tags:
        - Gestión de Roles
      summary: Desactivar/Activar Rol (Toggle Estado)
      description: Cambia el estado 'active' del rol.
      parameters:
        - in: path
          name: roleId
          schema:
            type: integer
          description: ID del rol a modificar.
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleStatusRequest'
      responses:
        '200':
          description: Estado del rol actualizado exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
     
  /api/parish/{parishId}/roles/{roleId}/permissions:
    get:
      tags:
        - Gestión de Roles (Permisos)
      summary: Obtener Listado de Permisos del Rol
      description: Obtiene el listado de permisos actual del rol, organizada por módulos y acciones.
      parameters:
        - in: path
          name: roleId
          schema:
            type: integer
          description: ID del rol para consultar permisos.
          required: true
      responses:
        '200':
          description: Matriz de permisos obtenida exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Permisos del rol obtenidos exitosamente"
                data:
                  role_name: "Rol de Ejemplo 1"
                  modules:
                    - module_name: "Actos Litúrgicos"
                      sections:
                        - section_name: "Gestionar actos litúrgicos"
                          permissions:
                            - id: 1
                              name: "Crear acto litúrgico"
                              assigned: true
                            - id: 2
                              name: "Actualizar estado acto litúrgico"
                              assigned: true
                            - id: 3
                              name: "Leer acto litúrgico"
                              assigned: true
                            - id: 4
                              name: "Actualizar acto litúrgico"
                              assigned: false
                            - id: 5
                              name: "Eliminar acto litúrgico"
                              assigned: false
                        - section_name: "Gestionar requisitos"
                          permissions:
                            - id: 6
                              name: "Crear requisitos"
                              assigned: true
                            - id: 7
                              name: "Actualizar estado requisitos"
                              assigned: true
                            - id: 8
                              name: "Leer requisitos"
                              assigned: true
                            - id: 9
                              name: "Actualizar requisitos"
                              assigned: false
                            - id: 10
                              name: "Eliminar requisitos"
                              assigned: false
                        - section_name: "Gestionar horarios"
                          permissions:
                            - id: 11
                              name: "Crear horario"
                              assigned: true
                            - id: 12
                              name: "Actualizar horario"
                              assigned: false
                            - id: 13
                              name: "Crear Excepción - Disponibilidad"
                              assigned: false
                            - id: 14
                              name: "Actualizar Excepción - Disponibilidad"
                              assigned: false
                            - id: 15
                              name: "Eliminar Excepción - Disponibilidad"
                              assigned: false
                            - id: 16
                              name: "Crear Excepción NO - Disponibilidad"
                              assigned: false
                            - id: 17
                              name: "Actualizar Excepción NO - Disponibilidad"
                              assigned: false
                            - id: 18
                              name: "Eliminar Excepción NO - Disponibilidad"
                              assigned: false
                        - section_name: "Gestionar Reservas"
                          permissions:
                            - id: 19
                              name: "Leer reservas"
                              assigned: true
                            - id: 20
                              name: "Actualizar reservas"
                              assigned: true
                    - module_name: "Reservas"
                      sections:
                        - section_name: "Reservas pendientes"
                          permissions:
                            - id: 21
                              name: "Eliminar reserva (Pendientes)"
                              assigned: false
                        - section_name: "Historial de reservas"
                          permissions:
                            - id: 22
                              name: "Leer reserva (Historial)"
                              assigned: true
                        - section_name: "Reservar evento"
                          permissions:
                            - id: 23
                              name: "Crear reserva"
                              assigned: true
                    - module_name: "Seguridad"
                      sections:
                        - section_name: "Gestionar cuentas"
                          permissions:
                            - id: 24
                              name: "Crear asociación usuario"
                              assigned: true
                            - id: 25
                              name: "Actualizar estado asociación usuario"
                              assigned: true
                            - id: 26
                              name: "Leer asociación usuario"
                              assigned: true
                            - id: 27
                              name: "Crear rol - asociación usuario"
                              assigned: false
                            - id: 28
                              name: "Eliminar asociación usuario"
                              assigned: false
                        - section_name: "Gestionar roles"
                          permissions:
                            - id: 29
                              name: "Crear rol"
                              assigned: true
                            - id: 30
                              name: "Actualizar estado rol"
                              assigned: true
                            - id: 31
                              name: "Leer rol"
                              assigned: true
                            - id: 32
                              name: "Actualizar rol - permisos"
                              assigned: true
                            - id: 33
                              name: "Actualizar rol"
                              assigned: false
                            - id: 34
                              name: "Eliminar rol"
                              assigned: false
                    - module_name: "Parroquia"
                      sections:
                        - section_name: "Gestionar cuenta"
                          permissions:
                            - id: 35
                              name: "Leer información de la parroquia"
                              assigned: true
                            - id: 36
                              name: "Actualizar información de la parroquia"
                              assigned: false
                            - id: 37
                              name: "Leer Datos de la cuenta"
                              assigned: false
                            - id: 38
                              name: "Actualizar Datos de la cuenta"
                              assigned: false
                        - section_name: "Gestionar capilla"
                          permissions:
                            - id: 39
                              name: "Crear capilla"
                              assigned: true
                            - id: 40
                              name: "Actualizar estado capilla"
                              assigned: false
                            - id: 41
                              name: "Leer capilla"
                              assigned: true
                            - id: 42
                              name: "Actualizar capilla"
                              assigned: false
                            - id: 43
                              name: "Eliminar capilla"
                              assigned: false
                error: ""
                traceback: ""

    put:
      tags:
        - Gestión de Roles (Permisos)
      summary: Guardar Cambios en listado de Permisos
      description: Guarda los cambios realizados en el listado de permisos del rol (botón "Guardar" del modal).
      parameters:
        - in: path
          name: roleId
          schema:
            type: integer
          description: ID del rol al que se modificarán los permisos.
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RolePermissionsUpdateRequest'
      responses:
        '200':
          description: Permisos del rol actualizados exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Permisos del rol actualizados exitosamente"
                data: {}
                error: ""
                traceback: ""