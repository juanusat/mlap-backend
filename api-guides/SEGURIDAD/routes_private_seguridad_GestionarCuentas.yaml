openapi: 3.0.0
info:
  title: Gesti√≥n de Cuentas de Trabajadores (Parroquia)
  description: APIs para la administraci√≥n de usuarios asociados a una Parroquia espec√≠fica, incluyendo listado, invitaci√≥n, asignaci√≥n de roles y gesti√≥n de la asociaci√≥n laboral.
  version: 1.0.0
servers:
  - url: /
    description: URL base para las APIs

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      
  schemas:
    WorkerSummary:
      type: object
      description: Resumen de la informaci√≥n de un trabajador (persona + asociaci√≥n).
      properties:
        association_id:
          type: integer
          description: ID de la asociaci√≥n laboral (tabla association).
          example: 1
        person_id:
          type: integer
          description: ID de la persona.
          example: 101
        first_names:
          type: string
          description: Nombres de la persona.
          example: Usuario1
        paternal_surname:
          type: string
          description: Apellido paterno de la persona.
          example: Apellido1
        email:
          type: string
          format: email
          description: Correo electr√≥nico.
          example: usuario1@example.com
        active:
          type: boolean
          description: Estado de la asociaci√≥n laboral (activa/inactiva).
          example: true

    WorkerListResponse:
      type: object
      properties:
        total_records:
          type: integer
          description: N√∫mero total de trabajadores que cumplen el filtro.
          example: 100
        total_pages:
          type: integer
          description: N√∫mero total de p√°ginas.
          example: 10
        current_page:
          type: integer
          description: N√∫mero de p√°gina actual.
          example: 1
        workers:
          type: array
          items:
            $ref: '#/components/schemas/WorkerSummary'

    WorkerInviteRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          description: Correo electr√≥nico de la persona a asociar/invitar.
          example: usuario@ejemplo.com

    WorkerInviteExistingResponse:
      type: object
      properties:
        message:
          type: string
          example: Usuario asociado exitosamente a la parroquia.
        association_id:
          type: integer
          description: ID de la nueva asociaci√≥n.
          example: 456

    WorkerInviteNewResponse:
      type: object
      properties:
        message:
          type: string
          example: Usuario no encontrado. Se ha enviado una invitaci√≥n por correo electr√≥nico para que se registre y se asocie a la parroquia.

    WorkerDetails:
      type: object
      description: Informaci√≥n del trabajador para la vista de roles.
      properties:
        association_id:
          type: integer
          example: 1
        first_names:
          type: string
          example: Usuario1
        paternal_surname:
          type: string
          example: Apellido1
        email:
          type: string
          format: email
          example: usuario1@example.com

    ActiveRole:
      type: object
      description: Detalle de un rol activo.
      properties:
        user_role_id:
          type: integer
          description: ID de la asignaci√≥n de rol (user_role), usado para la revocaci√≥n.
          example: 50
        role_id:
          type: integer
          description: ID del rol (tabla role).
          example: 5
        role_name:
          type: string
          description: Nombre del rol.
          example: Administrador
        assignment_date:
          type: string
          format: date
          description: Fecha de asignaci√≥n del rol.
          example: 2024-01-10

    WorkerRolesResponse:
      type: object
      description: Listado de roles activos de un trabajador.
      properties:
        worker_details:
          $ref: '#/components/schemas/WorkerDetails'
        active_roles:
          type: array
          items:
            $ref: '#/components/schemas/ActiveRole'

    RoleAssignmentRequest:
      type: object
      required:
        - role_id
      properties:
        role_id:
          type: integer
          description: ID del rol de la Parroquia a asignar.
          example: 7

    RoleAssignmentResponse:
      type: object
      properties:
        message:
          type: string
          example: Rol asignado exitosamente al trabajador.
        user_role_id:
          type: integer
          description: ID del nuevo registro user_role.
          example: 51
        role_name:
          type: string
          description: Nombre del rol asignado.
          example: Vicario

    RoleRevocationResponse:
      type: object
      properties:
        message:
          type: string
          example: Rol revocado exitosamente para el trabajador.
        user_role_id:
          type: integer
          example: 50
        revocation_date:
          type: string
          format: date
          description: Fecha de revocaci√≥n del rol.
          example: 2025-09-27

    AssociationStatusRequest:
      type: object
      required:
        - active
      properties:
        active:
          type: boolean
          description: true para activar, false para suspender/desactivar temporalmente.
          example: false

    AssociationStatusResponse:
      type: object
      properties:
        message:
          type: string
          example: Estado de la asociaci√≥n actualizado exitosamente (Suspendida).
        association_id:
          type: integer
          example: 1
        active:
          type: boolean
          example: false

    StandardResponse:
      type: object
      properties:
        message:
          type: string
          description: Lo que el backend indica al frontend que debe mostrar
          example: "Usuario(Trabajador) invitado exitosamente"
        data:
          description: La informaci√≥n, puede ser un arreglo
          oneOf:
            - type: object
            - type: array
            - type: integer
            - type: string
          example: {}
        error:
          type: string
          description: Es vac√≠o si no hay ning√∫n error
          example: ""
        traceback:
          type: string
          description: Todo el error generado en el backend si la respuesta es c√≥digo 500
          example: ""

    WorkerListRequest:
      type: object
      required:
        - page
        - limit
      properties:
        page:
          type: integer
          description: N√∫mero de p√°gina
          example: 1
        limit:
          type: integer
          description: L√≠mite de registros por p√°gina
          example: 10

    WorkerSearchRequest:
      type: object
      required:
        - page
        - limit
        - search
      properties:
        page:
          type: integer
          description: N√∫mero de p√°gina
          example: 1
        limit:
          type: integer
          description: L√≠mite de registros por p√°gina
          example: 10
        search:
          type: string
          description: T√©rmino de b√∫squeda para filtrar trabajadores (ej. por nombre o email)
          example: "Usuario"

    RoleListRequest:
      type: object
      required:
        - page
        - limit
      properties:
        page:
          type: integer
          description: N√∫mero de p√°gina
          example: 1
        limit:
          type: integer
          description: L√≠mite de registros por p√°gina
          example: 10

security:
  - bearerAuth: []

paths:
  /api/parish/{parishId}/workers/list:
    post:
      tags:
        - Gesti√≥n de Cuentas (Trabajadores)
      summary: Listar Trabajadores Asociados a la Parroquia
      description: Obtiene la lista paginada de personas activamente asociadas a la parroquia {parishId}.
      parameters:
        - in: path
          name: parishId
          schema:
            type: integer
          description: ID de la Parroquia que se est√° administrando.
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkerListRequest'
      responses:
        '200':
          description: Listado paginado de trabajadores.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Trabajadores obtenidos exitosamente"
                data:
                  total_records: 100
                  total_pages: 10
                  current_page: 1
                  workers:
                    - association_id: 1
                      person_id: 101
                      first_names: Usuario1
                      paternal_surname: Apellido1
                      email: usuario1@example.com
                      active: true
                error: ""
                traceback: ""
    
  /api/parish/{parishId}/workers/search:
    post:
      tags:
        - Gesti√≥n de Cuentas (Trabajadores)
      summary: Buscar Trabajadores Asociados a la Parroquia
      description: Busca trabajadores por nombre o email en la parroquia {parishId}.
      parameters:
        - in: path
          name: parishId
          schema:
            type: integer
          description: ID de la Parroquia que se est√° administrando.
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkerSearchRequest'
      responses:
        '200':
          description: Resultados de b√∫squeda de trabajadores.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "B√∫squeda de trabajadores completada exitosamente"
                data:
                  total_records: 5
                  total_pages: 1
                  current_page: 1
                  workers:
                    - association_id: 1
                      person_id: 101
                      first_names: Usuario1
                      paternal_surname: Apellido1
                      email: usuario1@example.com
                      active: true
                error: ""
                traceback: ""
    
  /api/parish/{parishId}/workers/create:
    post:
      tags:
        - Gesti√≥n de Cuentas (Trabajadores)
      summary: Invitar/Asociar Usuario a la Parroquia
      description: Asocia una Persona/Usuario existente o env√≠a una invitaci√≥n para crear una cuenta y asociarse a la Parroquia.
      parameters:
        - in: path
          name: parishId
          schema:
            type: integer
          description: ID de la Parroquia.
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkerInviteRequest'
      responses:
        '200':
          description: Usuario existente asociado exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Usuario asociado exitosamente a la parroquia"
                data:
                  association_id: 456
                error: ""
                traceback: ""
       

  /api/security/parish-workers/{id}/roles/list:
    post:
      tags:
        - Gesti√≥n de Cuentas (Roles)
      summary: Listar Roles Activos de un Trabajador Asociado
      description: Lista todos los roles activos que tiene un trabajador en la parroquia con paginaci√≥n.
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          description: ID de la asociaci√≥n laboral del trabajador.
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleListRequest'
      responses:
        '200':
          description: Roles activos listados exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Roles activos del trabajador obtenidos exitosamente"
                data:
                  total_records: 3
                  total_pages: 1
                  current_page: 1
                  items:
                    - user_role_id: 101
                      role_id: 1
                      role_name: "Administrador"
                      assignment_date: "2024-01-15"
                    - user_role_id: 102
                      role_id: 2
                      role_name: "Secretario"
                      assignment_date: "2024-02-10"
                    - user_role_id: 103
                      role_id: 3
                      role_name: "Vicario"
                      assignment_date: "2024-03-05"
                error: ""
                traceback: ""
    
  /api/security/parish-workers/{id}/roles/create:
    post:
      tags:
        - Gesti√≥n de Cuentas (Roles)
      summary: Asignar Nuevo Rol a Usuario
      description: Asigna un rol espec√≠fico de la parroquia a un trabajador activo.
      parameters:
        - in: path
          name: associationId
          schema:
            type: integer
          description: ID de la asociaci√≥n laboral del trabajador.
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleAssignmentRequest'
      responses:
        '201':
          description: Rol asignado exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Rol asignado exitosamente al trabajador"
                data:
                  user_role_id: 105
                  role_name: "Secretario"
                error: ""
                traceback: ""


  /api/parish/user-roles/{userRoleId}:
    delete:
      tags:
        - Gesti√≥n de Cuentas (Roles)
      summary: Revocar Rol Espec√≠fico de Usuario
      description: Revoca un rol espec√≠fico del usuario usando el user_role_id obtenido del listado. Corresponde al bot√≥n de eliminar (üóëÔ∏è) de cada rol individual.
      parameters:
        - in: path
          name: userRoleId
          schema:
            type: integer
          description: ID de la asignaci√≥n de rol espec√≠fica a revocar (obtenido del listado de roles).
          required: true
      responses:
        '200':
          description: Rol espec√≠fico revocado exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Rol revocado exitosamente"
                data:
                  user_role_id: 102
                  role_name: "Secretario"
                  revocation_date: "2025-10-06"
                  worker_name: "Usuario1"
                error: ""
                traceback: ""
      
  /api/parish/associations/{associationId}/status:
    patch:
      tags:
        - Gesti√≥n de Cuentas (Asociaci√≥n)
      summary: Desactivar/Activar Asociaci√≥n Laboral (Toggle Estado)
      description: Suspende/reestablece temporalmente la cuenta de trabajo del usuario, cambiando el campo 'active' de la asociaci√≥n.
      parameters:
        - in: path
          name: associationId
          schema:
            type: integer
          description: ID de la asociaci√≥n laboral a modificar.
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssociationStatusRequest'
      responses:
        '200':
          description: Estado de la asociaci√≥n actualizado exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Estado de la asociaci√≥n actualizado exitosamente"
                data:
                  association_id: 12
                  active: false
                error: ""
                traceback: ""
     
  /api/parish/associations/{associationId}:
    delete:
      tags:
        - Gesti√≥n de Cuentas (Asociaci√≥n)
      summary: Dar de Baja Definitiva de la Asociaci√≥n Laboral (Borrado L√≥gico)
      description: Finaliza permanentemente la relaci√≥n laboral del trabajador con la parroquia, actualizando la fecha de fin ('end_date') y 'active=false' en la tabla 'association'.
      parameters:
        - in: path
          name: associationId
          schema:
            type: integer
          description: ID de la asociaci√≥n laboral a finalizar.
          required: true
      responses:
        '200':
          description: Asociaci√≥n laboral finalizada exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Asociaci√≥n laboral finalizada exitosamente"
                data:
                  association_id: 12
                  end_date: "2025-10-06"
                error: ""
                traceback: ""
    