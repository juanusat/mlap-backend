openapi: 3.0.0
info:
  title: Módulo Seguridad - Seleccionar Parroquia
  description: APIs para que el usuario seleccione la parroquia donde trabajará y el rol que desempeñará en dicha parroquia.
  version: 1.0.0
servers:
  - url: /
    description: URL base para las APIs de selección de parroquia

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      
  schemas:
    ParishSummary:
      type: object
      description: Información resumida de una parroquia disponible para el usuario
      properties:
        parish_id:
          type: integer
          description: ID de la parroquia
          example: 1
        name:
          type: string
          description: Nombre de la parroquia
          example: "Parroquia Nuestra Señora de la Consolación"
        location:
          type: string
          description: Ubicación o dirección de la parroquia
          example: "Av. Principal 123, Ciudad"
        diocese_name:
          type: string
          description: Nombre de la diócesis a la que pertenece
          example: "Diócesis Central"
        association_status:
          type: string
          enum: ["ACTIVE", "PENDING", "INACTIVE"]
          description: Estado de la asociación del usuario con esta parroquia
          example: "ACTIVE"

    RoleSummary:
      type: object
      description: Información de un rol disponible en la parroquia seleccionada
      properties:
        role_id:
          type: integer
          description: ID del rol
          example: 5
        name:
          type: string
          description: Nombre del rol
          example: "Administrador"
        description:
          type: string
          description: Descripción del rol
          example: "Administrador general del sistema parroquial"
        is_default:
          type: boolean
          description: Indica si este rol es el rol por defecto para nuevos usuarios
          example: true
        permissions_count:
          type: integer
          description: Número de permisos asociados al rol
          example: 15

    ParishRoleSelection:
      type: object
      description: Selección de parroquia y rol por parte del usuario
      properties:
        parish_id:
          type: integer
          description: ID de la parroquia seleccionada
          example: 1
        role_id:
          type: integer
          description: ID del rol seleccionado
          example: 5

    UserParishAssociation:
      type: object
      description: Información de la asociación establecida entre usuario y parroquia
      properties:
        association_id:
          type: integer
          description: ID de la nueva asociación creada
          example: 123
        parish_info:
          type: object
          properties:
            parish_id:
              type: integer
              example: 1
            name:
              type: string
              example: "Parroquia Nuestra Señora de la Consolación"
            location:
              type: string
              example: "Av. Principal 123, Ciudad"
        role_info:
          type: object
          properties:
            role_id:
              type: integer
              example: 5
            name:
              type: string
              example: "Administrador"
            description:
              type: string
              example: "Administrador general del sistema parroquial"
        start_date:
          type: string
          format: date
          description: Fecha de inicio de la asociación
          example: "2025-10-05"
        status:
          type: string
          enum: ["ACTIVE", "PENDING_APPROVAL"]
          description: Estado inicial de la asociación
          example: "ACTIVE"

    StandardResponse:
      type: object
      properties:
        message:
          type: string
          description: Lo que el backend indica al frontend que debe mostrar
          example: "Parroquias disponibles obtenidas exitosamente"
        data:
          description: La información, puede ser un arreglo
          oneOf:
            - type: object
            - type: array
            - type: integer
            - type: string
          example: {}
        error:
          type: string
          description: Es vacío si no hay ningún error
          example: ""
        traceback:
          type: string
          description: Todo el error generado en el backend si la respuesta es código 500
          example: ""

security:
  - bearerAuth: []

paths:
  /api/user/parishes/list:
    post:
      tags:
        - Selección de Parroquia
      summary: Listar Parroquias Disponibles para el Usuario
      description: Obtiene la lista de parroquias donde el usuario tiene permisos para trabajar o puede solicitar asociación.
      security:
        - bearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties: {}
      responses:
        '200':
          description: Parroquias disponibles obtenidas exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Parroquias disponibles obtenidas exitosamente"
                data:
                  - parish_id: 1
                    name: "Parroquia Nuestra Señora de la Consolación"
                    location: "Av. Principal 123, Ciudad"
                    diocese_name: "Diócesis Central"
                    association_status: "ACTIVE"
                  - parish_id: 2
                    name: "Parroquia San José Obrero"
                    location: "Calle Segunda 456, Ciudad"
                    diocese_name: "Diócesis Central"
                    association_status: "PENDING"
                error: ""
                traceback: ""

  /api/user/parishes/search:
    post:
      tags:
        - Selección de Parroquia
      summary: Buscar Parroquias por Nombre o Ubicación
      description: Busca parroquias disponibles para el usuario por nombre o ubicación.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - search
              properties:
                search:
                  type: string
                  description: Término de búsqueda (nombre o ubicación)
                  example: "Consolación"
      responses:
        '200':
          description: Búsqueda de parroquias completada exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Búsqueda de parroquias completada exitosamente"
                data:
                  - parish_id: 1
                    name: "Parroquia Nuestra Señora de la Consolación"
                    location: "Av. Principal 123, Ciudad"
                    diocese_name: "Diócesis Central"
                    association_status: "ACTIVE"
                error: ""
                traceback: ""

  /api/user/parishes/{parishId}/roles/list:
    post:
      tags:
        - Selección de Roles
      summary: Listar Roles Disponibles en una Parroquia
      description: Obtiene los roles disponibles que el usuario puede seleccionar en la parroquia especificada.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: parishId
          schema:
            type: integer
          description: ID de la parroquia seleccionada
          required: true
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties: {}
      responses:
        '200':
          description: Roles disponibles obtenidos exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Roles disponibles obtenidos exitosamente"
                data:
                  - role_id: 1
                    name: "Administrador"
                    description: "Administrador general del sistema parroquial"
                    is_default: true
                    permissions_count: 25
                  - role_id: 2
                    name: "Secretario"
                    description: "Secretario de la parroquia"
                    is_default: false
                    permissions_count: 10
                  - role_id: 3
                    name: "Párroco"
                    description: "Párroco principal"
                    is_default: false
                    permissions_count: 30
                error: ""
                traceback: ""

  /api/user/parishes/select:
    post:
      tags:
        - Establecer Asociación
      summary: Seleccionar Parroquia y Rol de Trabajo
      description: Establece la asociación del usuario con una parroquia específica y asigna el rol seleccionado.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - parish_id
                - role_id
              properties:
                parish_id:
                  type: integer
                  description: ID de la parroquia seleccionada
                  example: 1
                role_id:
                  type: integer
                  description: ID del rol seleccionado
                  example: 5
      responses:
        '201':
          description: Asociación establecida exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Asociación con la parroquia establecida exitosamente"
                data:
                  association_id: 123
                  parish_info:
                    parish_id: 1
                    name: "Parroquia Nuestra Señora de la Consolación"
                    location: "Av. Principal 123, Ciudad"
                  role_info:
                    role_id: 5
                    name: "Administrador"
                    description: "Administrador general del sistema parroquial"
                  start_date: "2025-10-05"
                  status: "ACTIVE"
                error: ""
                traceback: ""
        '409':
          description: El usuario ya tiene una asociación activa con esta parroquia.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Asociación duplicada"
                data: {}
                error: "Ya tienes una asociación activa con esta parroquia"
                traceback: ""

  /api/user/parishes/current:
    get:
      tags:
        - Información de Sesión
      summary: Obtener Parroquia y Rol Activos del Usuario
      description: Obtiene información de la parroquia y rol actualmente seleccionados por el usuario.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Información de sesión obtenida exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Información de sesión obtenida exitosamente"
                data:
                  current_parish:
                    parish_id: 1
                    name: "Parroquia Nuestra Señora de la Consolación"
                    location: "Av. Principal 123, Ciudad"
                  current_role:
                    role_id: 5
                    name: "Administrador"
                    description: "Administrador general del sistema parroquial"
                  association_id: 123
                  start_date: "2025-10-05"
                  status: "ACTIVE"
                error: ""
                traceback: ""
        '404':
          description: No hay parroquia activa seleccionada.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "No hay parroquia activa"
                data: {}
                error: "No tienes una parroquia seleccionada actualmente"
                traceback: ""

  /api/user/parishes/switch:
    post:
      tags:
        - Cambiar Contexto
      summary: Cambiar a Otra Parroquia
      description: Permite al usuario cambiar su contexto de trabajo a otra parroquia donde ya tiene asociación.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - parish_id
              properties:
                parish_id:
                  type: integer
                  description: ID de la parroquia a la que cambiar
                  example: 2
                role_id:
                  type: integer
                  description: ID del rol a activar (opcional, usa el rol por defecto si no se especifica)
                  example: 3
      responses:
        '200':
          description: Contexto de parroquia cambiado exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Contexto cambiado exitosamente"
                data:
                  previous_parish: "Parroquia Nuestra Señora de la Consolación"
                  current_parish:
                    parish_id: 2
                    name: "Parroquia San José Obrero"
                    location: "Calle Segunda 456, Ciudad"
                  current_role:
                    role_id: 3
                    name: "Párroco"
                    description: "Párroco principal"
                error: ""
                traceback: ""
        '403':
          description: No tienes asociación con la parroquia solicitada.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Acceso denegado"
                data: {}
                error: "No tienes una asociación activa con esta parroquia"
                traceback: ""