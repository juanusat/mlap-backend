openapi: 3.0.0
info:
  title: Gestión de Reservas de Actos Litúrgicos
  description: APIs para la gestión (listado, búsqueda, detalle y actualización) de las reservas de eventos litúrgicos asociadas a la parroquia activa.
  version: 1.0.0
servers:
  - url: /
    description: URL base para las APIs

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ReservationStatus:
      type: string
      enum: [RESERVED, REJECTED, IN_PROGRESS, COMPLETED, FULFILLED, CANCELLED]
      description: Estado de la reserva.
      
    UserPersonSummary:
      type: object
      description: Resumen de la persona que realiza la reserva.
      properties:
        id:
          type: integer
          description: ID de la persona.
          example: 10
        full_name:
          type: string
          description: Nombre completo de la persona.
          example: Usuario 1

    UserPersonDetail:
      type: object
      description: Detalle de la persona que realiza la reserva.
      properties:
        id:
          type: integer
          description: ID de la persona.
          example: 10
        full_name:
          type: string
          description: Nombre completo.
          example: Usuario 1
        email:
          type: string
          format: email
          description: Correo electrónico de contacto.
          example: user1@mail.com
        document:
          type: string
          description: Número de documento de identidad.
          example: 12345678

    ChapelRef:
      type: object
      properties:
        id:
          type: integer
          description: ID de la Capilla.
          example: 101
        name:
          type: string
          description: Nombre de la Capilla.
          example: Capilla San José

    EventVariantRef:
      type: object
      properties:
        id:
          type: integer
          description: ID de la variante de evento (Acto Litúrgico).
          example: 5
        name:
          type: string
          description: Nombre de la variante.
          example: Funeral
        chapel:
          $ref: '#/components/schemas/ChapelRef'

    ReservationSummary:
      type: object
      description: Estructura de una Reserva para el listado principal.
      properties:
        id:
          type: integer
          description: ID de la reserva.
          example: 1
        user_person:
          $ref: '#/components/schemas/UserPersonSummary'
        event_variant_name:
          type: string
          description: Nombre de la variante de evento.
          example: Funeral
        event_date:
          type: string
          format: date-time
          description: Fecha y hora (ISO 8601) del acto reservado.
          example: 2025-08-13T00:00:00Z
        paid_amount:
          type: number
          format: float
          description: Monto pagado hasta la fecha.
          example: 449.00
        status:
          $ref: '#/components/schemas/ReservationStatus'

    ReservationDetail:
      type: object
      description: Información completa de una reserva específica.
      properties:
        id:
          type: integer
          description: ID de la reserva.
          example: 1
        event_variant:
          $ref: '#/components/schemas/EventVariantRef'
        person:
          $ref: '#/components/schemas/UserPersonDetail'
        event_date:
          type: string
          format: date-time
          description: Fecha y hora del acto reservado.
          example: 2025-08-13T00:00:00Z
        registration_date:
          type: string
          format: date-time
          description: Fecha y hora en que se registró la reserva.
          example: 2025-07-01T10:00:00Z
        reschedule_date:
          type: string
          format: date-time
          nullable: true
          description: Fecha de reprogramación (si aplica).
          example: null
        status:
          $ref: '#/components/schemas/ReservationStatus'
        paid_amount:
          type: number
          format: float
          description: Monto pagado hasta la fecha.
          example: 449.00

    ReservationListResponse:
      type: object
      properties:
        total_records:
          type: integer
          description: Número total de registros que cumplen el filtro.
          example: 100
        total_pages:
          type: integer
          description: Número total de páginas.
          example: 10
        current_page:
          type: integer
          description: Número de página actual.
          example: 1
        data:
          type: array
          items:
            $ref: '#/components/schemas/ReservationSummary'

    ReservationUpdateRequest:
      type: object
      properties:
        event_date:
          type: string
          format: date-time
          description: Nueva fecha y hora del acto reservado.
          example: 2025-09-01T15:00:00Z
        paid_amount:
          type: number
          format: float
          description: Monto pagado actualizado.
          example: 500.00
        reschedule_date:
          type: string
          format: date-time
          nullable: true
          description: Fecha y hora de reprogramación.
          example: 2025-08-01T10:00:00Z

    ReservationStatusUpdateRequest:
      type: object
      required:
        - new_status
      properties:
        new_status:
          $ref: '#/components/schemas/ReservationStatus'
          description: Nuevo estado de la reserva.
          example: COMPLETED

    StandardResponse:
      type: object
      properties:
        message:
          type: string
          description: Lo que el backend indica al frontend que debe mostrar
          example: "Reserva actualizada exitosamente"
        data:
          description: La información, puede ser un arreglo
          oneOf:
            - type: object
            - type: array
            - type: integer
            - type: string
          example: {}
        error:
          type: string
          description: Es vacío si no hay ningún error
          example: ""
        traceback:
          type: string
          description: Todo el error generado en el backend si la respuesta es código 500
          example: ""

    ReservationListRequest:
      type: object
      required:
        - page
        - limit
      properties:
        page:
          type: integer
          description: Número de página
          example: 1
        limit:
          type: integer
          description: Límite de registros por página
          example: 10

    ReservationSearchRequest:
      type: object
      required:
        - page
        - limit
        - search
      properties:
        page:
          type: integer
          description: Número de página
          example: 1
        limit:
          type: integer
          description: Límite de registros por página
          example: 10
        search:
          type: string
          description: Término de búsqueda por nombre de usuario
          example: "Usuario"

security:
  - bearerAuth: []

paths:
  /api/acts/reservations/list:
    post:
      tags:
        - Gestión de Reservas
      summary: Listar Reservas
      description: Obtiene un listado paginado de las reservas. Requiere permiso READ_RESERVATIONS.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReservationListRequest'
      responses:
        '200':
          description: Listado paginado de reservas.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Reservas obtenidas exitosamente"
                data:
                  - id: 1
                    user_person:
                      id: 10
                      full_name: Usuario 1
                    event_variant_name: Funeral
                    event_date: '2025-08-13T00:00:00Z'
                    paid_amount: 449.00
                    status: RESERVED
                error: ""
                traceback: ""
                meta:
                  total_records: 100


  /api/acts/reservations/search:
    post:
      tags:
        - Gestión de Reservas
      summary: Buscar Reservas
      description: Busca reservas por nombre de usuario. Requiere permiso READ_RESERVATIONS.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReservationSearchRequest'
      responses:
        '200':
          description: Resultados de búsqueda de reservas.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Búsqueda de reservas completada exitosamente"
                data:
                  - id: 1
                    user_person:
                      id: 10
                      full_name: Usuario 1
                    event_variant_name: Funeral
                    event_date: '2025-08-13T00:00:00Z'
                    paid_amount: 449.00
                    status: RESERVED
                error: ""
                traceback: ""
                meta:
                  total_records: 100

  /api/acts/reservations/{id}:
    get:
      tags:
        - Gestión de Reservas
      summary: Obtener Detalles de una Reserva
      description: Obtiene la información completa de una reserva específica.
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          description: ID de la reserva.
          required: true
      responses:
        '200':
          description: Detalles de la reserva obtenidos exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Detalles de la reserva obtenidos exitosamente"
                data:
                  id: 1
                  event_name: Funeral
                  event_date: '2025-08-13T00:00:00Z'
                  user_name: Usuario 1
                  paid_amount: 449.00
                  status: RESERVED
                error: ""
                traceback: ""
    
  /api/acts/reservations/{id}/status:
    patch:
      tags:
        - Gestión de Reservas
      summary: Actualizar el Estado de una Reserva
      description: Actualiza el campo 'status' de la reserva. Requiere permiso UPDATE_RESERVATION_STATUS.
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          description: ID de la reserva a actualizar.
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReservationStatusUpdateRequest'
      responses:
        '200':
          description: Estado de la reserva actualizado exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Estado de la reserva actualizado exitosamente"
                data: {}
                error: ""
                traceback: ""

  /api/acts/reservations/{id}/reject:
    patch:
      tags:
        - Gestión de Reservas
      summary: Rechazar una Reserva
      description: Cambia el estado de una reserva de 'RESERVED' a 'REJECTED'. Requiere permiso UPDATE_RESERVATION_STATUS.
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          description: ID de la reserva a rechazar.
          required: true
          example: 1
      responses:
        '200':
          description: Reserva rechazada exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Reserva rechazada exitosamente"
                data: 
                  id: 1
                  status: "REJECTED"
                error: ""
                traceback: ""

  /api/acts/reservations/{id}/payments:
    get:
      tags:
        - Gestión de Pagos
      summary: Listar Pagos de una Reserva
      description: Obtiene el historial de pagos realizados para una reserva específica.
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          description: ID de la reserva.
          required: true
          example: 1
      responses:
        '200':
          description: Lista de pagos obtenida exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Pagos obtenidos exitosamente"
                data:
                  - id: 1
                    reservation_id: 1
                    amount: 50.00
                    payment_date: "2025-10-20T15:00:00Z"
                    registered_by_worker_id: null
                    registered_by_worker_name: null
                  - id: 2
                    reservation_id: 1
                    amount: 30.00
                    payment_date: "2025-10-25T10:00:00Z"
                    registered_by_worker_id: 3
                    registered_by_worker_name: "Pamela Saavedra Sanchez"
                error: ""
                traceback: ""
    
    post:
      tags:
        - Gestión de Pagos
      summary: Registrar un Pago
      description: Crea un nuevo registro de pago para una reserva. El trabajador que lo registra se toma del token JWT.
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          description: ID de la reserva.
          required: true
          example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - amount
              properties:
                amount:
                  type: number
                  format: float
                  description: Monto del pago a registrar.
                  example: 50.00
      responses:
        '201':
          description: Pago registrado exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardResponse'
              example:
                message: "Pago registrado exitosamente"
                data:
                  id: 3
                  reservation_id: 1
                  amount: 50.00
                  payment_date: "2025-11-21T10:30:00Z"
                  registered_by_worker_id: 2
                error: ""
                traceback: ""
        