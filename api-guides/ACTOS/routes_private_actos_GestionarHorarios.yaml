openapi: 3.0.1
info:
  title: Gestión de Horarios de Capillas
  description: |
    Esta API maneja la disponibilidad general y las excepciones de horario para las capillas de una parroquia.
    Permite a los administradores definir horarios semanales recurrentes y gestionar fechas específicas
    de apertura o cierre.
  version: 1.0.0
servers:
  - url: /api
    description: Servidor Principal

paths:
  /api/parishes/{parish_id}/chapels/{chapel_id}/general-schedules/list:
    post:
      tags:
        - Horario General
      summary: Obtener el horario semanal recurrente de una capilla
      description: Devuelve todos los intervalos de disponibilidad general que definen el horario estándar de la capilla.
      parameters:
        - $ref: '#/components/parameters/parish_id'
        - $ref: '#/components/parameters/chapel_id'
      requestBody:
        description: Aunque este listado no es paginado, se mantiene el método POST por consistencia.
        required: true
        content:
          application/json:
            schema:
              type: object
              properties: {}
      responses:
        '200':
          description: Lista de intervalos del horario general obtenida con éxito.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseGeneralScheduleList'

  /api/parishes/{parish_id}/chapels/{chapel_id}/general-schedules/bulk-update:
    post:
      tags:
        - Horario General
      summary: Actualizar en bloque todo el horario semanal recurrente
      description: Reemplaza completamente el horario general existente de una capilla con el nuevo conjunto de intervalos proporcionado. Se utiliza al guardar los cambios en la cuadrícula de edición.
      parameters:
        - $ref: '#/components/parameters/parish_id'
        - $ref: '#/components/parameters/chapel_id'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                schedules:
                  type: array
                  items:
                    $ref: '#/components/schemas/GeneralScheduleInput'
              example:
                schedules:
                  - day_of_week: 0 # Lunes
                    start_time: "09:00:00"
                    end_time: "12:00:00"
                  - day_of_week: 1 # Martes
                    start_time: "15:00:00"
                    end_time: "18:00:00"
      responses:
        '200':
          description: Horario general actualizado correctamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseSuccess'

  /api/parishes/{parish_id}/chapels/{chapel_id}/specific-schedules/list:
    post:
      tags:
        - Horarios Específicos (Excepciones)
      summary: Listar excepciones de horario de forma paginada
      description: Obtiene una lista paginada de excepciones (disponibilidad o no disponibilidad). Permite filtrar por tipo y rango de fechas.
      parameters:
        - $ref: '#/components/parameters/parish_id'
        - $ref: '#/components/parameters/chapel_id'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListRequest'
            examples:
              proximas_disponibles:
                summary: Próximas de disponibilidad
                value:
                  page: 1
                  limit: 4
                  filters:
                    exception_type: "OPEN"
                    date_range:
                      start: "2025-10-12"
              pasadas_no_disponibles:
                summary: Pasadas de no disponibilidad
                value:
                  page: 1
                  limit: 4
                  filters:
                    exception_type: "CLOSED"
                    date_range:
                      end: "2025-10-11"
      responses:
        '200':
          description: Lista de excepciones obtenida con éxito.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseSpecificScheduleList'

  /api/parishes/{parish_id}/chapels/{chapel_id}/specific-schedules/create:
    post:
      tags:
        - Horarios Específicos (Excepciones)
      summary: Crear una nueva excepción de horario
      description: Registra una nueva excepción de disponibilidad ('OPEN') o no disponibilidad ('CLOSED') para una fecha específica.
      parameters:
        - $ref: '#/components/parameters/parish_id'
        - $ref: '#/components/parameters/chapel_id'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SpecificScheduleInput'
      responses:
        '201':
          description: Excepción creada correctamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseSuccess'

  /api/parishes/{parish_id}/chapels/{chapel_id}/specific-schedules/{schedule_id}:
    parameters:
      - $ref: '#/components/parameters/parish_id'
      - $ref: '#/components/parameters/chapel_id'
      - $ref: '#/components/parameters/schedule_id'
    put:
      tags:
        - Horarios Específicos (Excepciones)
      summary: Actualizar una excepción de horario existente
      description: Modifica los detalles de una excepción específica identificada por su ID.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SpecificScheduleInput'
      responses:
        '200':
          description: Excepción actualizada correctamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseSuccess'
    delete:
      tags:
        - Horarios Específicos (Excepciones)
      summary: Eliminar una excepción de horario
      description: Elimina permanentemente una excepción de la base de datos.
      responses:
        '200':
          description: Excepción eliminada con éxito.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseSuccess'

components:
  parameters:
    parish_id:
      name: parish_id
      in: path
      required: true
      description: ID de la parroquia a la que pertenece la capilla.
      schema:
        type: integer
    chapel_id:
      name: chapel_id
      in: path
      required: true
      description: ID de la capilla para la cual se gestiona el horario.
      schema:
        type: integer
    schedule_id:
      name: schedule_id
      in: path
      required: true
      description: ID de la excepción de horario específica.
      schema:
        type: integer

  schemas:
    # ====== ESQUEMAS DE DATOS ======
    GeneralSchedule:
      type: object
      properties:
        id:
          type: integer
          example: 1
        day_of_week:
          type: integer
          description: "Día de la semana (0=Lunes, 6=Domingo)"
          example: 0
        start_time:
          type: string
          format: time
          example: "09:00:00"
        end_time:
          type: string
          format: time
          example: "12:00:00"

    SpecificSchedule:
      type: object
      properties:
        id:
          type: integer
          example: 15
        date:
          type: string
          format: date
          example: "2025-11-01"
        start_time:
          type: string
          format: time
          example: "10:00:00"
        end_time:
          type: string
          format: time
          example: "13:00:00"
        exception_type:
          type: string
          enum: [OPEN, CLOSED]
          example: "OPEN"
        reason:
          type: string
          example: "Misa especial"

    # ====== ESQUEMAS DE ENTRADA (REQUEST BODY) ======
    GeneralScheduleInput:
      type: object
      properties:
        day_of_week:
          type: integer
          description: "Día de la semana (0=Lunes, 6=Domingo)"
          example: 0
        start_time:
          type: string
          format: time
          example: "09:00:00"
        end_time:
          type: string
          format: time
          example: "12:00:00"

    SpecificScheduleInput:
      type: object
      properties:
        date:
          type: string
          format: date
          example: "2025-12-25"
        start_time:
          type: string
          format: time
          example: "10:00"
        end_time:
          type: string
          format: time
          example: "12:00"
        exception_type:
          type: string
          enum: [OPEN, CLOSED]
          example: "CLOSED"
        reason:
          type: string
          example: "Feriado por Navidad"

    ListRequest:
      type: object
      properties:
        page:
          type: integer
          description: Número de la página a obtener.
          example: 1
        limit:
          type: integer
          description: Cantidad de registros por página.
          example: 4
        filters:
          type: object
          properties:
            exception_type:
              type: string
              enum: [OPEN, CLOSED]
            date_range:
              type: object
              properties:
                start:
                  type: string
                  format: date
                  description: "Filtra fechas a partir de este día (inclusivo)."
                end:
                  type: string
                  format: date
                  description: "Filtra fechas hasta este día (inclusivo)."

    # ====== ESQUEMAS DE RESPUESTA ======
    ApiResponse:
      type: object
      properties:
        message:
          type: string
        data:
          type: object
          nullable: true
        error:
          type: string
        traceback:
          type: string
          nullable: true
        meta:
          type: object
          properties:
            total_records:
              type: integer

    ApiResponseSuccess:
      allOf:
        - $ref: '#/components/schemas/ApiResponse'
      properties:
        data:
          type: object
          properties:
            id:
              type: integer
      example:
        message: "Operación realizada con éxito."
        data: { id: 123 }
        error: ""
        traceback: null

    ApiResponseGeneralScheduleList:
      allOf:
        - $ref: '#/components/schemas/ApiResponse'
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/GeneralSchedule'
      example:
        message: "Horario general obtenido con éxito."
        data:
          - id: 1
            day_of_week: 0
            start_time: "09:00:00"
            end_time: "12:00:00"
          - id: 2
            day_of_week: 1
            start_time: "15:00:00"
            end_time: "18:00:00"
        error: ""
        traceback: null
        meta:
          total_records: 2

    ApiResponseSpecificScheduleList:
      allOf:
        - $ref: '#/components/schemas/ApiResponse'
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/SpecificSchedule'
      example:
        message: "Excepciones obtenidas con éxito."
        data:
          - id: 15
            date: "2025-11-01"
            start_time: "10:00:00"
            end_time: "13:00:00"
            exception_type: "OPEN"
            reason: "Misa especial"
        error: ""
        traceback: null
        meta:
          total_records: 5
